<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="https://ovh.github.io/cds/images/favicon.png" type="image/x-icon" />
    <title>Write your own hatchery :: CDS Documentation</title>
    <link href="https://ovh.github.io/cds/css/nucleus.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/hybrid.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/featherlight.min.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/horsey.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/theme.css" rel="stylesheet">
    <link href="https://ovh.github.io/cds/css/hugo-theme.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ovh.github.io/cds/css/bootstrap.min.css">
    <script src="https://ovh.github.io/cds/js/jquery-2.x.min.js"></script>
    <style type="text/css">:root #header + #content > #left > #rlblock_left
    {display:none !important;}</style>
    

  </head>
  <body class="" data-url="/tutorials/tutorials.hatchery-create/">
    
<nav id="sidebar">
  <div id="header-wrapper">
    <div id="header">
       
	<p><img src="https://ovh.github.io/cds/images/cds-transparent.png?width=40px" alt="CDS" /></p>
 


    </div>
    
  </div>

  <div class="highlightable">
    <ul class="topics">
        

        
        
        
        
            
    
    

    <li data-nav-id="/introduction/introduction/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/introduction/introduction/">
            Introduction
            
            
              
                <i style="color:grey" class="fa fa-angle-right section-icon"></i>
              
            
        </a>
        
    </li>

        
            
    
    

    <li data-nav-id="/getting-started/getting-started.first-pipeline-ui/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/getting-started/getting-started.first-pipeline-ui/">
            Getting Started
            
            
        </a>
        
    </li>

        
            
    
    

    <li data-nav-id="/building-pipelines/building-pipelines/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/building-pipelines/building-pipelines/">
            Building Pipelines
            
            
              
                <i style="color:grey" class="fa fa-angle-right section-icon"></i>
              
            
        </a>
        
    </li>

        
            
    
    

    <li data-nav-id="/building-workflows/building-workflows/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/building-workflows/building-workflows/">
            Building Workflows
            
            
              
                <i style="color:grey" class="fa fa-angle-right section-icon"></i>
              
            
        </a>
        
    </li>

        
            
    
    

    <li data-nav-id="/installation/installation/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/installation/installation/">
            Installation
            
            
              
                <i style="color:grey" class="fa fa-angle-right section-icon"></i>
              
            
        </a>
        
    </li>

        
            
    
    

    <li data-nav-id="/advanced/advanced/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/advanced/advanced/">
            Advanced
            
            
              
                <i style="color:grey" class="fa fa-angle-right section-icon"></i>
              
            
        </a>
        
    </li>

        
            
    
    

    <li data-nav-id="/tutorials/tutorials/" class="dd-item
    
    parent">
        <a href="https://ovh.github.io/cds/tutorials/tutorials/">
            Tutorials
            
            
              
                <i style="color:grey" class="fa fa-angle-right section-icon"></i>
              
            
        </a>
        
            
            
            
                <ul>
                
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.worker-setup/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.worker-setup/">
            Worker Setup
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.hatchery-create/" class="dd-item
    active
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.hatchery-create/">
            Write your own hatchery
            
            
        </a>
        
            
            
            
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.worker-model-docker-simple/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.worker-model-docker-simple/">
            Setup Worker Model From Docker Hub
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.worker-model-docker-customized/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.worker-model-docker-customized/">
            Setup Docker Worker Model with your own image
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.worker-model-openstack/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.worker-model-openstack/">
            Setup Openstack Worker Model
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.worker-model-vsphere/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.worker-model-vsphere/">
            Setup VSphere Worker Model
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.service-link-requirement-nginx/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.service-link-requirement-nginx/">
            Service Requirement Nginx
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.service-link-requirement-pg/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.service-link-requirement-pg/">
            Service Requirement PostgreSQL
            
            
        </a>
        
    </li>

                    
                
                    
                        
    
    

    <li data-nav-id="/tutorials/tutorials.cds-track/" class="dd-item
    
    ">
        <a href="https://ovh.github.io/cds/tutorials/tutorials.cds-track/">
            Track CDS Pipeline from Git command line 
            
            
        </a>
        
    </li>

                    
                
                </ul>
             
        
    </li>

        





        
        <section id="shortcuts">
            
                <li class="" role="">
                    <h3></h3>
                    <a href="https://github.com/ovh/cds"><i class='fa fa-github'></i> Source Code</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="https://github.com/ovh/cds/releases"><i class='fa fa-download'></i> Releases</a>
                    
                </li>
            
                <li class="" role="">
                    
                    <a href="https://gitter.im/ovh-cds/Lobby"><i class='fa fa-commenting'></i> Gitter</a>
                    
                </li>
            
        </section>

        

        
    </ul>


    <section id="footer">
      <section style="text-align:center">
  <p>Built with <a href="http://gohugo.io/">Hugo</a> and <a href="https://github.com/vjeantet/hugo-theme-docdock">docdock theme</a></i></p>
  <p>CDS is an <a href="https://github.com/ovh">OVH OSS</a></p>
  <p><a href="https://ovh.com"><img src="https://ovh.github.io/tat/imgs/ovh-logo.png"></a></p>
</section>

    </section>
  </div>
</nav>



        <section id="body">
        <div id="overlay"></div>

        <div class="padding highlightable">
        
          <div id="top-bar">
              
                
                
                
              <div id="top-github-link">
                  <a class="github-link" href="https://github.com/ovh/cds/edit/master/docs/content/tutorials/tutorials.hatchery-create.md" target="blank">
                    <i class="fa fa-code-fork"></i>
                    Edit this page
                  </a>
              </div>
                
              
              <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">

                  <span id="sidebar-toggle-span">
                      <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                        <i class="fa fa-bars"></i>
                      </a>
                  </span>
                  <span id="toc-menu"><a href=""><i class="fa fa-list-alt"></i></a></span>

                      <a href="https://ovh.github.io/cds">
                      <span class="fa fa-arrow-circle-right" style="font-size:larger" aria-hidden="true"></span>
                      CDS Documentation</a>
                      
                         / <a href='https://ovh.github.io/cds/tutorials/tutorials/'>Tutorials</a> / <a href='https://ovh.github.io/cds/tutorials/tutorials.hatchery-create/'>Write your own hatchery</a>
                      
                      
              </div>

                  <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#example-with-a-creation-of-a-vsphere-hatchery">Example with a creation of a VSphere hatchery</a></li>
<li><a href="#test">Test</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

            </div>
        
              
            <div id="body-inner">
              
              <h1>Write your own hatchery</h1>
              



<h3 id="example-with-a-creation-of-a-vsphere-hatchery">Example with a creation of a VSphere hatchery</h3>

<ul>
<li><p>First of all you need to create a new package like the other into the hatchery package. Let&rsquo;s call this package vsphere for our example.</p></li>

<li><p>You have to implement the Service interface (see <a href="https://github.com/ovh/cds/blob/master/engine/types.go">here</a>) in order to configure launch this new hatchery mode via CDS engine CLI.</p></li>

<li><p>Your have to create a Configuration structure composed of the <a href="https://godoc.org/github.com/ovh/cds/sdk/hatchery#CommonConfiguration">hatchery.CommonConfiguration</a> and the variables you need to access to Vsphere API. You finally have to update the <a href="https://github.com/ovh/cds/blob/master/engine/main.go">engine main.go file</a> to manage this new service and add and manage the configuration structure as part of the <a href="https://github.com/ovh/cds/blob/master/engine/types.go">global configuration</a>.</p></li>

<li><p>You need to implement the hatchery interface (see <a href="https://godoc.org/github.com/ovh/cds/sdk/hatchery#Interface">here</a>)</p></li>

<li><p>The <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Init">Init</a> function is useful to create the struct and to set all of these parameters, for our example it&rsquo;s in this function that we&rsquo;re going to create all our VSphere informations fetched from the VSphere API. (cf <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Init">init.go</a>). In this case we create a new vsphere client to request vsphere API, a new finder to fetch all informations about our vsphere host. In fact, all informations that we need to spawn and kill the vms with our workers inside on the vsphere infrastructure. This function is also used to create and register the hatchery on the api via the function in the sdk called <a href="https://godoc.org/github.com/ovh/cds/sdk/hatchery#Register">hatchery.Register</a>. This register will give you the id of your hatchery.</p></li>

<li><p>The <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.ID">ID</a> function returns the id of the current hatchery that comes from the hatchery client registered with the sdk previously in the <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Init">Init</a> function.</p></li>

<li><p>The <a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.ModelType">ModelType</a> function returns the type of the hatchery, in this case it&rsquo;s vsphere type. We can create a constant VSphere inside our <a href="https://godoc.org/github.com/ovh/cds/sdk#pkg-constants">sdk package</a>.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Hatchery">Hatchery</a> function returns the hatchery struct initialised previously in the <code>Init</code> function.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.Client">Client</a> function returns the sdk client initialised previously in the <code>Init</code> function too.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.NeedRegistration">NeedRegistration</a> is used to know if your worker model need registration. For example if a user update a worker model you have to rebuild the virtual machine model linked to this worker model. And this function returns true if the worker model was updated after the virtual machine model was created on vsphere. In order to know that for vsphere we have add some metadata on each vms in order to add more custom data as the last creation of this vm for example.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.CanSpawn">CanSpawn</a> function checks if the hatchery can spawn this model. For example with vsphere with check if there is a memory requirement, if it&rsquo;s the case it returns false because it&rsquo;s not already supported by our vsphere hatchery for now.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.WorkersStartedByModel">WorkersStartedByModel</a> returns all workers which are running with a worker model. In our vsphere example, in order to know that we register a string metadata called model which tell us the name of our worker model.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.WorkersStarted">WorkersStarted</a> returns all workers include those which are running to build a vm model or to register a worker model. For example in the vsphere case, in order to count them we all prefix our worker spawned with <code>worker-</code>.</p></li>

<li><p><a href="https://godoc.org/github.com/ovh/cds/engine/hatchery/vsphere#HatcheryVSphere.CanSpawn">CanSpawn</a> is where the magic happens, it&rsquo;s in this function that you spawn your vms with the right configuration. In fact with vsphere we check if there is a vm model already created for the worker model passed in parameter. If it doesn&rsquo;t we create a vm model with the user data store in worker model infos. Then we spawn a vm with right environment variables created from informations passed in parameters (workerModel, registerOnly, &hellip;) and with a script inside the vm that download the worker binary, execute it and shutdown when all is done. In this function we also check if the worker should be launch to register or to execute steps. When we launch a worker for register it means that the worker is launched and then send all there binary capabilities to the api for this worker model but don&rsquo;t execute any jobs.</p></li>

<li><p>In our vsphere implementation we also launch multiple goroutine to clean and kill workers which seem down or in error. It&rsquo;s a ticker that check all vms state in a periodic way.</p></li>
</ul>

<h3 id="test">Test</h3>

<p>If you want to test that you just have to launch it like that :</p>

<pre><code class="language-bash">$ engine start hatchery:vsphere --config config.toml
</code></pre>


<footer class=" footline" >
	
</footer>



      </div>
    </div>

    
 
    

    <div id="navigation">
        

          
        
              
            
                
                    
                        
                        
                    
                
            
                
                    
                    
                
            
                
                    
                        
                        
                            
                                
                            
                        
                    
                
            
                
                    
                        
                        
                            
                        
                    
                
            
                
                    
                        
                        
                            
                        
                    
                
            
                
                    
                        
                        
                            
                        
                    
                
            
                
                    
                        
                        
                            
                        
                    
                
            
                
                    
                        
                        
                            
                        
                    
                
            
                
                    
                        
                        
                            
                        
                    
                
            

            
                <a class="nav nav-prev" href="https://ovh.github.io/cds/tutorials/tutorials.worker-setup/" title="Worker Setup"> <i class="fa fa-chevron-left"></i></a>
            
            
                <a class="nav nav-next" href="https://ovh.github.io/cds/tutorials/tutorials.worker-model-docker-simple/" title="Setup Worker Model From Docker Hub" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
            
        
    </div>

    </section>
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://ovh.github.io/cds/js/clipboard.min.js"></script>
    <script src="https://ovh.github.io/cds/js/perfect-scrollbar.min.js"></script>
    <script src="https://ovh.github.io/cds/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="https://ovh.github.io/cds/js/jquery.sticky-kit.min.js"></script>
    <script src="https://ovh.github.io/cds/js/featherlight.min.js"></script>
    <script src="https://ovh.github.io/cds/js/html5shiv-printshiv.min.js"></script>
    <script src="https://ovh.github.io/cds/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://ovh.github.io/cds/js/modernizr.custom.71422.js"></script>
    <script src="https://ovh.github.io/cds/js/learn.js"></script>
    <script src="https://ovh.github.io/cds/js/hugo-learn.js"></script>

    
    <link href="https://ovh.github.io/cds/mermaid/mermaid.css" type="text/css" rel="stylesheet"/>
    <script src="https://ovh.github.io/cds/mermaid/mermaid.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    

    

  </body>
</html>

