<ng-container *ngIf="workflowRun">
    <div class="content" [class.disableSelection]="resizing">

        <!--  GRAPH -->
        <div class="graph">
            <nz-page-header class="title" nzBackIcon (nzBack)="onBack()">
                <nz-page-header-title>
                    <a [routerLink]="['/project', projectKey, 'explore', 'vcs', workflowRun.vcs_server, 'repository', workflowRun.repository, 'workflow', workflowRun.workflow_name]"
                        [queryParams]="{branch: workflowRun.contexts.git.ref_name}">
                        {{workflowRun.vcs_server}}/{{workflowRun.repository}}/{{workflowRun.workflow_name}}</a>&nbsp;
                    #{{workflowRun.run_number}}
                    <nz-select *ngIf="workflowRun.run_attempt > 1 && selectedRunAttempt" [ngModel]="selectedRunAttempt"
                        (ngModelChange)="changeRunAttempt($event)" nzSize="small" title="Select run attempt">
                        <nz-option *ngFor="let item of [].constructor(workflowRun.run_attempt); let i = index"
                            [nzValue]="workflowRun.run_attempt-i" [nzLabel]="workflowRun.run_attempt-i"></nz-option>
                    </nz-select>
                    <button nz-button nzType="default" nzSize="small" title="Show workflow sources"
                        (click)="navigatePanel('workflow')"><span nz-icon nzType="file-text"
                            nzTheme="outline"></span></button>
                    <button nz-button nzType="default" nzSize="small" title="Show workflow run contexts"
                        (click)="navigatePanel('contexts')"><span nz-icon nzType="read"
                            nzTheme="outline"></span></button>
                </nz-page-header-title>
                <nz-page-header-content>
                    <span nz-typography nzType="secondary">
                        Commit <a href="{{workflowRun.contexts.git.commit_web_url}}" target="_blank"
                            rel="noopener noreferrer">{{workflowRun.contexts.git.sha?.substring(0,8)}}</a> - <a
                            href="{{workflowRun.contexts.git.ref_web_url}}" target="_blank"
                            rel="noopener noreferrer">{{workflowRun.contexts.git.ref}}</a> by
                        {{workflowRun.contexts.git.username}}
                        on
                        repository
                        <a href="{{workflowRun.contexts.git.repository_web_url}}" target="_blank"
                            rel="noopener noreferrer">{{workflowRun.contexts.git.server}}/{{workflowRun.contexts.git.repository}}</a>
                        <span *ngIf="workflowRun.contexts.cds.workflow_template">
                            <br />
                            Generated from template
                            <a
                                [routerLink]="['/project', projectKey, 'explore', 'vcs', workflowRun.contexts.cds.workflow_template_vcs_server, 'repository', workflowRun.contexts.cds.workflow_template_repository, 'workflowtemplate', workflowRun.contexts.cds.workflow_template]">
                                {{workflowRun.contexts.cds.workflow_template_vcs_server}}/{{workflowRun.contexts.cds.workflow_template_repository}}/{{workflowRun.contexts.cds.workflow_template}}</a>
                            <span class="templateDetails" nz-icon nzType="eye" nzTheme="outline" nz-tooltip
                                [nzTooltipTitle]="templateTooltip"></span>
                            <ng-template #templateTooltip>
                                Repository: <a href="{{workflowRun.contexts.cds.workflow_template_repository_web_url}}"
                                    target="_blank"
                                    rel="noopener noreferrer">{{workflowRun.contexts.cds.workflow_template_repository}}</a>
                                <br /> Commit: <a href="{{workflowRun.contexts.cds.workflow_template_commit_web_url}}"
                                    target="_blank"
                                    rel="noopener noreferrer">{{workflowRun.contexts.cds.workflow_template_sha?.substring(0,8)}}</a>
                                <br />Ref: <a href="{{workflowRun.contexts.cds.workflow_template_ref_web_url}}"
                                    target="_blank"
                                    rel="noopener noreferrer">{{workflowRun.contexts.cds.workflow_template_ref}}</a>
                            </ng-template>
                        </span>
                        <span *ngIf="workflowRun.annotations">
                            <span *ngFor="let annotation of workflowRun.annotations | keyvalue">
                                <br />{{annotation.key}}: {{annotation.value}}
                            </span>
                        </span>
                    </span>
                </nz-page-header-content>
            </nz-page-header>
            <div class="controls">
                <span nz-icon nzType="play-circle" nzTheme="outline" title="Restart failed jobs"
                    (click)="clickRestartJobs()"></span>
                <span nz-icon nzType="stop" nzTheme="outline" title="Stop workflow run" (click)="clickStopRun()"></span>
            </div>
            <app-stages-graph [workflow]="workflowGraph" [runJobs]="jobs" [workflowRun]="workflowRun"
                [navigationDisabled]="!!selectedItemType" (onSelectJobGate)="openPanel('gate', $event)"
                (onSelectJobRun)="navigatePanel('job', $event)" (onSelectHook)="navigatePanel('hook', $event)"
                #graph></app-stages-graph>
        </div>

        <!--  BOTTOM PANELS -->
        <app-resizable-panel [direction]="'vertical'" minSize="200" [initialSize]="infoPanelSize"
            (onGrabbingStart)="panelStartResize()" (onGrabbingEnd)="infoPanelEndResize($event)">

            <div class="bottom-panel">
                <app-tabs [tabs]="tabs" (onSelect)="selectTab($event)"></app-tabs>
                <ul *ngIf="selectedTab && selectedTab.key === 'problems'" class="infos">
                    <ng-container *ngFor="let info of workflowRunInfos">
                        <li *ngIf="info.level === 'error'">
                            <span class="error" nz-icon nzType="close-circle" nzTheme="fill"></span>
                            <div class="content">
                                {{info.message}}
                            </div>
                        </li>
                    </ng-container>
                    <ng-container *ngFor="let info of workflowRunInfos">
                        <li *ngIf="info.level === 'warning'">
                            <span class="warning" nz-icon nzType="warning" nzTheme="fill"></span>
                            <div class="content">
                                {{info.message}}
                            </div>
                        </li>
                    </ng-container>
                </ul>
                <ul *ngIf="selectedTab && selectedTab.key === 'infos'" class="infos">
                    <ng-container *ngFor="let info of workflowRunInfos">
                        <li *ngIf="info.level==='info'">
                            <span class="info" nz-icon nzType="info-circle" nzTheme="fill"></span>
                            <div class="content">
                                {{info.message}}.
                            </div>
                        </li>
                    </ng-container>
                </ul>
                <nz-table *ngIf="selectedTab && selectedTab.key === 'results'" class="results" [nsAutoHeightTable]="86"
                    nzSize="small" [nzShowPagination]="false" [nzPageSize]="results?.length ?? 0" [nzData]="results"
                    #autoHeightDirective=nsAutoHeightTable #resultsTable>
                    <thead>
                        <tr>
                            <th nzWidth="100px">Type</th>
                            <th>Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="result" *ngFor="let result of resultsTable.data"
                            (click)="navigatePanel('result', result.id)">
                            <td>
                                {{result.type}}
                            </td>
                            <td>
                                <ng-container *ngIf="result.type === 'deployment'; else nameTmpl">
                                    {{result.detail.data.deployment_name}}:{{result.detail.data.version}}
                                </ng-container>
                                <ng-template #nameTmpl>
                                    {{result.detail.data.name ?? result.id}}
                                </ng-template>
                            </td>
                        </tr>
                    </tbody>
                </nz-table>
                <app-run-tests *ngIf="selectedTab && selectedTab.key === 'tests'" [tests]="tests"
                    (onSelectTest)="openPanel('test', $event)"></app-run-tests>
                <ng-template #tabTestsTemplate>
                    <div class="tests">
                        Tests
                        <span class="ok" *ngIf="tests && tests.ok > 0">
                            <span nz-icon nzType="check" nzTheme="outline"></span>{{tests.ok}}
                        </span>
                        <span class="skipped" *ngIf="tests && tests.skipped > 0">
                            <span nz-icon nzType="warning" nzTheme="fill"></span>{{tests.skipped}}
                        </span>
                        <span class="ko" *ngIf="tests && tests.ko > 0">
                            <span nz-icon nzType="close" nzTheme="outline"></span>{{tests.ko}}
                        </span>
                    </div>
                </ng-template>
            </div>
        </app-resizable-panel>
    </div>

    <!--  RIGHT PANELS -->
    <app-resizable-panel *ngIf="selectedItemType" minSize="400" [initialSize]="jobPanelSize"
        (onGrabbingStart)="panelStartResize()" (onGrabbingEnd)="jobPanelEndResize($event)"
        (dblclick)="$event.stopPropagation(); dblClickOnPanel()">
        <div class="controls">
            <div class="control" (click)="clickClosePanel()">
                <span nz-icon nzType="close" nzTheme="outline"></span>
            </div>
            <div class="control" [class.expand]="!panelExpanded" [class.expanded]="panelExpanded"
                (click)="clickExpandPanel()">
                <span nz-icon nzType="vertical-align-top" nzTheme="outline"></span>
            </div>
        </div>
        <app-run-job *ngIf="selectedItemType === 'job'" [workflowRun]="workflowRun" [jobRun]="selectedJobRun"
            [jobRunInfos]="selectedJobRunInfos"></app-run-job>
        <app-run-gate *ngIf="selectedItemType === 'gate'" [gateNode]="selectedJobGate"
            [run]="workflowRun"></app-run-gate>
        <app-run-hook *ngIf="selectedItemType === 'hook'" [hook]="selectedHookName" [run]="workflowRun"></app-run-hook>
        <app-run-result *ngIf="selectedItemType === 'result'" [result]="selectedRunResult"></app-run-result>
        <app-run-workflow *ngIf="selectedItemType === 'workflow'" [workflow]="workflowGraph"></app-run-workflow>
        <app-run-contexts *ngIf="selectedItemType === 'contexts'" [run]="workflowRun"></app-run-contexts>
        <app-run-test *ngIf="selectedItemType === 'test'" [test]="selectedTest"></app-run-test>
    </app-resizable-panel>

</ng-container>